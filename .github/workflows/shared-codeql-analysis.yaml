name: Run CodeQL

on:
  workflow_call:
    inputs:
      runtime_version:
        description: 'The default Java runtime version to run builds on'
        required: false
        type: number
        default: 11
      publishing_branch_regex:
        description: 'The regular expression to determine if a certain branch build should be published'
        required: false
        type: string
        default: 'master|main|trunk|(\d+\.(?:\d+\.)?x)' # master or something like 0.8.x or 2.x
      extra_gradle_params:
        description: 'Extra arguments to pass to all Gradle invocations'
        required: false
        type: string
        default: ''

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: "Setup JDK ${{ inputs.runtime_version }}"
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: "${{ inputs.runtime_version }}"
    # Checks branch name to see if we're going to potentially publish this
    - name: Check branch for publish
      uses: zml2008/action-regex-match@temp-deprecation-fix # fork, to be PR'd upstream
      id: branch-name
      with:
        text: ${{ github.ref }}
        regex: '^refs/heads/(?:${{ inputs.publishing_branch_regex }})$'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: java
    - name: Build with Gradle
      uses: gradle/gradle-build-action@v2
      with:
        cache-read-only: "${{ steps.branch-name.outputs.match == '' || github.event_name == 'pull_request' }}"
        arguments: ${{ inputs.extra_gradle_params }} assemble
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
